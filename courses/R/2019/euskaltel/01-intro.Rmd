# Introducción al software estadístico `R` {#intro}


`R` es un entorno y lenguaje de programación orientado al análisis estadístico, al cálculo, manipulación de datos, y representaciones gráficas. Es multiplataforma y parte del sistema GNU y se distribuye con licencia GNU-GPL. 

Más información [aquí](https://es.wikipedia.org/wiki/R_(lenguaje_de_programaci%C3%B3n)).
&nbsp;


## Algunas cuestiones a tener en cuenta sobre `R`


 - `R` distingue mayúsculas y minúsculas.

 - Para asignar contenido a un objeto usamos `<-`. Por ejemplo, `x <- 10` asigna a `x` el valor `10`. También podemos usar =.

 - Para ver el contenido de un objeto simplemente escribimos su nombre.
 
 - Para usar los comandos escribimos el nombre del comando seguido de sus argumentos entre paréntesis. Por ejemplo, `ls()`da una lista de los objetos en el área de trabajo. Como no usamos argumentos (diferentes a los que el comando tenga por defecto) no escribimos nada en el paréntesis.

 - Para ver la clase de un objeto `class(obj)`.
 
 - Para obtener ayuda usamos el comando `help`. Por ejemplo, `help(mean)` para obtener ayuda sobre el comando `mean` que calcula la media. O simplemente `?mean`.
 
 - Para borrar objetos `rm()`.
 

## Guardar los resultados y el código

 - Al entrar en `R`, se considera cierto directorio por defecto como el directorio de trabajo. Este directorio puede cambiarse en el menú Archivo, `Cambiar dir`... Resulta conveniente tener un directorio diferente para cada proyecto que realicemos.

 - Al salir de `R` se nos pregunta `Guardar imagen de área de trabajo?`. Si respondemos afirmativamente, se crea un fichero `.RData` en el directorio de trabajo que contiene todos los objetos del área de trabajo en el momento de salir. Posteriormente, haciendo doble clic en este fichero podremos entrar en `R` y seguir trabajando exactamente en el mismo punto en que lo habíamos dejado al salir.

 - Alternativamente podemos usar los comandos `save` y `load` para guardar y recuperar objetos. Consulta la ayuda de estos comandos para ver sus diferentes opciones.

-  Todos los comandos y código de `R` se pueden guardar en un fichero de texto (con `extensión.R`) dentro del directorio de trabajo. El comando source se puede usar para ejecutar todo el código contenido en un fichero de texto. En el menú `Archivo`, `Abrir script` podemos acceder a un editor muy simple en el que poder ir escribiendo el código.


## Rstudio 

RStudio es un IDE (_Integrated Development Environment_ o Entorno de Desarrollo Integrado) de código abierto para `R`, que permite interactuar con `R` de manera muy simple. 

Entre otras ventajas, Rstudio utiliza diferentes colores para las distintas clases de objetos de `R`, permite autocompletar código, incluye un sistema de menús de ayuda muy completo, cuenta con un potente sistema para la gestión, descarga y construcción de librerías, dispone de un depurador de código que detecta posibles errores de sintaxis, es multiplataforma (existen versiones para Windows, Linux y Mac).



```{r rstudio,  fig.cap="Interfaz RStudio", echo=FALSE, out.width = '100%', fig.align='center'}
knitr::include_graphics("figures/rstudio_ide.png")
```


  **A la izquierda**, la consola donde se ejecutan los comandos de `R`.

  **A la derecha**, en la parte superior, tenemos una ventana que muestra nuestro entorno (_environment_) de trabajo, en el que iremos viendo las variables y funciones que vayamos cargando, creando, etc. 
  
  Obsérvese que esta ventana tiene algunos iconos que permiten guardar el contenido de la memoria, cargar el contenido de la memoria de una sesión de trabajo anterior, importar archivos de datos que se hayan guardado como texto, y limpiar el contenido de la memoria.

  A la derecha, en la parte inferior, se muestra el contenido de nuestro directorio home donde R arranca por defecto. Observemos que esta ventana tiene varias pestañas:

-  **Files:** archivos en el directorio actual.
-  **Plots:** en esta ventana se irán mostrando los gráficos que generemos con el programa.
-  **Packages:** permite ver qué librerías (colecciones de funciones que extienen la funcionalidad de R) tenemos instaladas; asimismo nos permite descargar e instalar nuevas librerías.
-  **Help:** permite acceder a ayuda sobre R.
-  **Viewer:** Permite acceder a contenido web local.


## Instalar un paquete de `R`


* Desde la consola

```{r, eval=FALSE}
install.packages("< Nombre del paquete >")
```

  + Ejemplo: 
    
```{r, eval=FALSE}
install.packages("DAAG")
install.packages(c("DAAG","psych")) # Varios paquetes con el comando c("< Paquete 1 >","< Paquete 2 >")
```

* Desde Rstudio: `Packages > Install` 

## Empezando con `R`

* Obtener el directorio de trabajo o *working directory*

```{r,eval=FALSE}
getwd() 
```

* listar los objetos en el espacio de trabajo o *workspace*

```{r,eval=FALSE}
ls()
```

* Definir el *working directory*

```{r, eval=FALSE}
setwd("/Users/dlee") 
```

* Desde Rstudio: `Files > Click en ... > More > Set as working directory` 

* Ver los últimos comandos utilizados en la consola

```{r,eval=FALSE}
history() # mostrar los últimos 25 comandos
history(max.show=Inf) # mostrar todos los comandos anteriores
```


* Guardar el historial de comandos

```{r,eval=FALSE}
savehistory(file="myfile") # el valor por defecto es ".Rhistory"
```

* Cargar los commandos guardados en una sesión anterior 

```{r,eval=FALSE}
loadhistory(file="myfile") # el valor por defecto es ".Rhistory"
```


* Salvar todo el **workspace** en un fichero `.RData` 

```{r, eval=FALSE}
save.image()
```

* Guardar objectos especificos a un fichero (si no se especifica la ruta en el ordenador, se guardará en el directorio actual de trabajo).

```{r,eval=FALSE}
save(<object list>,file="myfile.RData") 
```


* Cargar un *workspace* en la sesión 

```{r,eval=FALSE}
load("myfile.RData") 
```


* Salir de `R`. Por defecto `R` pregunta si deseas guardar la sesión. 

```{r,eval=FALSE}
q()
```


## Instalar y cargar librerías en `R`
 
```{r,eval=FALSE}
install.packages("DAAG") # (Data Analysis And Graphics)
```

* Una vez instalada la librería, tenemos que cargarla con el comando `library` o `require`

```{r,warning=FALSE,message=FALSE}
library(DAAG) # o require(DAAG)
```
 


## Lectura de datos

Consola de `R`


```{r}
x <- c(7.82,8.00,7.95) # c de "combinar"
x
```

Otra forma es mediante la función `scan()`

```{r,eval=FALSE}
x <- scan()  # introducir números seguidos de ENTER y terminar con un ENTER
1: 7.82
2: 8.00
3: 7.95
4: 
Read 3 items
```
Para crear un vector de caracteres `""`

```{r}
id <- c("John","Paul","George","Ringo")
```


To read a character vector 
```{r,eval=FALSE}
id <- scan(,"")
1: John
2: Paul
3: George
4: Ringo
5: 
Read 4 items  
```

```{r}
id
```


## Importar datos 

En ocasiones, necesitaremos leer datos de un fichero independiente. Existen varias formas de hacerlo: 

* `scan()` (`?scan` ver la ayuda)


```{r}
# creamos el fichero ex.txt
cat("Example:", "2 3 5 7", "11 13 17", file = "ex.txt", sep = "\n") 
scan("ex.txt", skip = 1)
scan("ex.txt", skip = 1, nlines = 1) # only 1 line after the skipped one
unlink("ex.data") # tidy up
```

* Existen diferentes formatos (`.txt`, `.csv`, `.xls`, `.xlsx`, `SAS`, `Stata`, etc...)

* Alguna librer?as de `R` para importar datos: 

```{r,message=FALSE,warning=FALSE}
library(gdata)
library(foreign)
``` 

\bigskip

* Generalmente leeros datos en formato `.txt` o `.csv` 

Descara en el siguiente link los datos `cardata` [aquí](data/cardata.zip)


```{r,eval=FALSE}
mydata1 = read.table("data/cardata.txt") 
mydata2 = read.csv("data/cardata.csv")  
```

* Otros formatos `.xls` and `.xlsx`

```{r,eval=FALSE,message=FALSE,warning=FALSE}
library(gdata)
mydata3 = read.xls ("cardata/cardata.xls", sheet = 1, header = TRUE)
```

* Minitab, SPSS, SAS or Stata

```{r, eval=FALSE, message=FALSE}
library(foreign)                   
mydata = read.mtp("mydata.mtp")  # Minitab
mydata = read.spss("myfile", to.data.frame=TRUE) # SPSS
mydata = read.dta("mydata.dta") # Stata
```

* O tambi?n 

```{r,eval=FALSE}
library(Hmisc)
mydata = spss.get("mydata.por", use.value.labels=TRUE)  # SPSS
```


## Exportar datos

* Existen diferentes maneras de exportar datos desde `R` en diferentes formatos. Para SPSS, SAS y Stata. Por ejemplo, mediante la librería `foreign`. En Excel, la librería `xlsx`.  
 
 - Texto delimitado por tabulaciones:

```{r,eval=FALSE}
mtcars
?mtcars    
write.table(mtcars, "cardata.txt", sep="\t") 
```

*  Hoja de cálculo de Excel:

```{r,eval=FALSE}
library(xlsx)
write.xlsx(mydata, "mydata.xlsx")
```



## Vectores

<!-- * Descargar el siguiente código de `R` [aquí](http://idaejin.github.io/bcam-courses/rbasics/rbasics.R) -->

* Crear dos vectores

```{r}
weight<-c(60,72,57,90,95,72)  
class(weight)
height<-c(1.75,1.80,1.65,1.90,1.74,1.91)
```

* calcular el Body Mass Index (*índice de masa corporal*)
```{r} 
bmi<- weight/height^2
bmi
```


## Estadística básica

* mean, median, st dev, variance

```{r,eval=FALSE}
mean(weight) 
median(weight)
sd(weight)
var(weight)
```

* Resumen de un vector

```{r}
summary(weight)
```

* o también

```{r,eval=FALSE}
min(weight)
max(weight)
range(weight)
sum(weight)
length(weight)
```

* Cuantiles y percentiles

```{r}
quantile(weight) # por defecto cuantil 25%, 50% y 75%
quantile(weight,c(0.32,0.57,0.98))
```

* Covarianza y correlación  

La covarianza ($\sigma_{xy}$) indica el grado de variacion conjunta de dos variables aleatorias respecto a sus medias

  - Si $\sigma_{xy}> 0$, hay dependencia directa (positiva), es decir, a grandes valores de $x$ corresponden grandes valores de $y$.
  - Si $\sigma_{xy}= 0$, hay una covarianza 0 se interpreta como la no existencia de una relación lineal entre las dos variables estudiadas.
  - Si $\sigma_{xy}< 0$m hay dependencia inversa o negativa, es decir, a grandes valores de $x$ corresponden peque?os valores de $y$.

$$
\rm{Cov}(x,y) = \frac{1}{n}\sum_{i=1}^{n}(x_i - \bar{x})(y_i - \bar{y})
$$

```{r}
cov(weight,height)
```

El *coeficiente de correlación* mide la relacion lineal (positiva o negativa) entre dos variables. Formalmente es el cociente entre la covarianza y el producto de las desviaciones t?picas de ambas variables. Siendo $\sigma_x$ y $\sigma_y$ las desviaciones estandar y  $\sigma_xy$ la covarianza entre $x$ e $y$.

$$
      \rho_{xy}  = \frac{\sigma_{xy}}{\sigma_x~\sigma_y}
$$

```{r}
cor(weight,height)
```


## Vectores caracteres y variables factor

```{r}
subject <- c("John","Peter","Chris","Tony","Mary","Jane")
sex <- c("MALE","MALE","MALE","MALE","FEMALE","FEMALE")
class(subject)
table(sex)
```



## Data frames
```{r}
Dat <- data.frame(subject,sex,weight,height)
# añadir el bmi a Dat
Dat$bmi <- bmi  # o Dat$bmi <- weight/height^2
class(Dat)
str(Dat) # Ver la estructura del data.frame
```


```{r}
# cambiar el nombre de las filas
rownames(Dat)<-c("A","B","C","D","E","F")

# Acceder a los elementos del data.frame
Dat[,1]     # columna 1
Dat[,1:3]   # columnas 1 a 3
Dat[1:2,]   # filas 1 a 2
```


## Trabajando con data frames

**Ejemplo: analizar datos por grupos**

*  Obtener el peso (`weight`), altura (`height`) y `bmi` por `FEMALES` y `MALES`:

1. Seleccionado cada grupo y calculando la media por grupos

```{r, results='hide'}
Dat[sex=="MALE",]
Dat[sex=="FEMALE",]

mean(Dat[sex=="MALE",3])  # weight average of MALEs
mean(Dat[sex=="MALE","weight"])
```

2. Mediante la función `apply` por columnas
```{r, results='hide'}
apply(Dat[sex=="FEMALE",3:5],2,mean)
apply(Dat[sex=="MALE",3:5],2,mean)

# podemos utilizar la función apply con cualquier función
apply(Dat[sex=="FEMALE",3:5],2,function(x){x+2})
```

3. función `by` o `colMeans`

```{r, results='hide'}
# 'by' divide los datos en factores y realiza 
#   los cálculos para cada grupo
by(Dat[,3:5],sex, colMeans) 
```

4. función `aggregate`

```{r, results='hide'}
# otra opción
aggregate(Dat[,3:5], by=list(sex),mean) 
```


## Vectores lógicos

* Elegir los individuos con `BMI>22`
```{r,results='hide'}
bmi
bmi>22
as.numeric(bmi>22) # convierte a numerico 0/1
which(bmi>22)  # nos devuelve la posicion del valor donde bmi>22
```

* Qué valores están entre 20 y 25?

```{r,results='hide'}
bmi > 20 & bmi < 25
which(bmi > 20 & bmi < 25)
```


## Trabajando con vectores

* Concatenar

```{r,results='hide'}
x <- c(2, 3, 5, 2, 7, 1)
y <- c(10, 15, 12)
z <- c(x,y)  # concatena x e y
```

* Lista de 2 vectores

```{r}
zz <- list(x,y) # crea una lista
unlist(zz) # deshace la lista convirtiéndola en un vector concatenado
``` 

* Subconjunto de vectores

```{r}
x[c(1,3,4)]

x[-c(2,6)] # simbolo - omite los elementos 
```

* Secuencias
```{r}
seq(1,9) # ó 1:9
seq(1,9,by=1)
seq(1,9,by=0.5)
seq(1,9,length=20)
```

* Réplicas

```{r,results='hide'}
oops <- c(7,9,13)
rep(oops,3)   # repite el vector "oops" 3 veces
rep(oops,1:3) # repite cada elemento del vector las veces indicadas

rep(c(2,3,5), 4)
rep(1:2,c(10,15))

rep(c("MALE","FEMALE"),c(4,2)) # también funciona con caracteres
c(rep("MALE",3), rep("FEMALE",2))
```


## Matrices y arrays

```{r}
x<- 1:12
x
dim(x)<-c(3,4)  # 3 filas y 4 columnas

X <- matrix(1:12,nrow=3,byrow=TRUE)
X

X <- matrix(1:12,nrow=3,byrow=FALSE)
X

# rownames, colnames

rownames(X) <- c("A","B","C")
X
colnames(X) <- LETTERS[4:7]
X
colnames(X) <- month.abb[4:7]
X
```

* Concatenar filas y columnas `rbind()`, `cbind()`

```{r}
Y <- matrix(0.1*(1:12),3,4)

cbind(X,Y)  # bind column-wise
rbind(X,Y)  # bind row-wise
```


## Factores

```{r}
gender<-c(rep("female",691),rep("male",692))
class(gender)

# cambiar vector a factor (por ejemplo a una categoria)
gender<- factor(gender)
levels(gender)

summary(gender)
table(gender)

status<- c(0,3,2,1,4,5)    # Crear vector numerico, 
                           #    transformarlo a niveles.
fstatus <- factor(status, levels=0:5)
levels(fstatus) <- c("student","engineer",
                     "unemployed","lawyer","economist","dentist")

Dat$status <- fstatus
Dat
```



##  Indexando vectores con condiciones lógicas

```{r}
a <- c(1,2,3,4,5)
b <- c(TRUE,FALSE,FALSE,TRUE,FALSE)

max(a[b])

sum(a[b])
```

## Valores faltantes

En `R`, los valores faltante (o *missing values*) se representan como `NA` (*not available*). Los valores imposibles (e.g., valores dividos por cero) se representan con el simbolo `NaN` (*not a number*). 

```{r}
a <- c(1,2,3,4,NA)
sum(a)
```

El argumento `na.rm=TRUE` excluye los valores `NA` en el cálculo de algunos valores

```{r}
sum(a,na.rm=TRUE)

a <- c(1,2,3,4,NA)
is.na(a) # YES or NO
```

La función `complete.cases()` devuelve un vector lógico que indica los casos completos.

```{r}
complete.cases(a)
```

La función `na.omit()` devuelve un objeto sin los elementos `NA`. 

```{r}
na.omit(a) 
```

`NA` en data frames:

```{r,results='hide'}
require(graphics)
?airquality
pairs(airquality, panel = panel.smooth, main = "airquality data")
ok <- complete.cases(airquality)
airquality[ok,]
```


## Trabajando con data frames

 * Los data frame se utilizand para guardas tablas de datos. Contiene elementos de la misma longitud.
 
```{r,results="hide"}
mtcars
?mtcars       # help(mtcars)
```
* Observemos las primeras filas

```{r}
head(mtcars)
```

* Estructura de un data frame

```{r}
str(mtcars) # visualiza la estructura del marco de datos
```

* Definición de las variables:

      + Modelo: Los tipos de coches son una mezcla que incluye sedanes (Datsun, Ford, Honda,...), sedanes de lujo (Mercedes, Cadellac,...), muscle cars (Javelin, Challenger, Camero...) y coches deportivos de alta gama (Porsche, Lotus, Maserati, Ferrari...).

      + `mpg`(_Miles/US Gallon_). Es la variable para determinar la eficiencia de combustible.
      
      + `cyl`(nº de cilindros). Los datos incluyen vehículos con motores de 4,6,8 cilindros.
      
      + `disp` (_displacement_). El desplazamiento mide el volumen total del motor como factor de circunstancia del cilindro, profundidad y número total de cilindros. Esta métrica da un buen proxy para la cantidad total de potencia que el motor puede generar.
      
      + `hp` (_horse power_). La potencia bruta mide la potencia teórica de un motor.
      
      + `drat` (_Relación del eje trasero_) . La relación de transmisión del eje trasero indica el número de vueltas del eje de transmisión por cada rotación del eje de la rueda. Un vehículo con una relación elevada proporcionaría, por ejemplo, más par y, por lo tanto, más capacidad de remolque. La configuración de la transmisión a menudo puede influir en la relación de transmisión de un fabricante.
      
      + `wt` (_peso (libras/1000)_). El peso total del vehículo por cada 1000 libras (media tonelada de EE.UU.).
      
      + `qsec` (1/4 mile time). Una medida de rendimiento, principalmente de la aceleración. El tiempo más rápido para viajar 1/4 de milla desde la parada (en segundos).

      + `vs` (V/S). Variable binaria que señala la configuración del cilindro del motor en forma de V (vs=0) o en línea recta (vs=1). `V===0` y `S==1`. 
      
      + `am` (tipo de transmisión). Variable binaria que indica si el vehículo tiene una transmisión automática (`am=0`) o manual (`am=1`).
      
      + `gear` (nº de marchas hacia adelante). Nº de marchas en la transmisión. Las transmisiones manuales tienen 4 ó 5 marchas hacia adelante; Automáticas 3 ó 4.
      
      + `carb` (nº de carburadores). 
      
      
* Seleccionar un modelo:
```{r}
mtcars["Mazda RX4",] # usando nombres de las filas y las columnas
mtcars[c("Datsun 710", "Camaro Z28"),] 
```

* O variables concretas

```{r}
mtcars[,c("mpg","am")]
```


*  La librería `psych`, contiene la función `describe` que permite calcular medidas descriptivas de un data frame:

```{r, message=FALSE, warning=FALSE}
library(psych)
describe(mtcars)
```

